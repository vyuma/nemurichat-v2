# 3Dキャラクター対話アプリ 要件定義書（ドラフト）

バージョン: 0.1-draft
作成日: 2025-12-19
担当: プロダクト/開発

## 1. 概要
- 3Dキャラクター（中学一年生設定）と対話できる没入型アプリ。
- 会話内容に応じて「表情」「声色」「モーション」を連動させることに注力。
- ゲーム性（退屈→眠気→就寝→ゲームオーバー）を持たせ、飽きさせない設計。
- 音声は TTS 取得後に口パクを開始。取得待ち中は「考える/首かしげ/相槌」等の軽いモーションで間を保つ。
- サーバー側で直接 LLM を自由生成させず、フラグ管理（状態機械・パラメーター駆動）を行う。
- 会話内容により声色も変化し、顔と声を同期（感情・表情・声色の連動）。
- 親密度（関係性）パラメーターを導入し、振る舞い・声色・表情・ゲーム難易度へ影響。
- チャット文字は TTS 音声準備後に字幕のように少しずつ表示。
- 音声は句読点単位で分割して遅延送信（API fetch）し、低遅延再生を実現。
- 既定の声は Coeiroink「MANA（ねむねむ）」を採用。感情に応じてパラメーター調整。

## 2. 目的・価値
- 技術的価値: 表情・声色・モーションの三位一体同期体験の実現。
- 体験価値: 会話のテンポと可視/可聴フィードバックで飽きにくい。
- 事業価値: キャラクター嗜好性の高いユーザーに継続利用を促進。

## 3. 前提/スコープ
- 対応プラットフォーム（初期想定）: Web（PC/モバイル）
  - 3D表示: WebGL（three.js もしくは Babylon.js）
  - TTS: Coeiroink API（MANA ねむねむ）。必要に応じて自前ホスト or 公式API。
- LLM: サーバーサイドでプロンプト→「意図/行動/感情フラグ」へ変換する用途に限定。
- キャラクタ年齢設定は中学一年生。倫理・法令・プラットフォームポリシーに準拠し、年齢に不相応なコンテンツは排除（安全フィルタ必須）。

## 4. 用語
- フラグ: 会話状態・感情・トピック・難易度・眠気・親密度などの離散/連続値。
- 親密度: ユーザーとの関係性メトリクス。会話質・継続時間で変動。
- 退屈度: つまらなさの指標。上昇で表情変化→眠気→就寝（ゲームオーバー）。
- ビセーム: 口パクの口形状（phoneme→viseme）対応。

## 5. ユースケース
- UC-1: ユーザーが話す/入力 → LLMで意図抽出 → フラグ更新 → キャラクターが応答（声/表情/モーション）。
- UC-2: 難しすぎ/つまらない話題が続く → 退屈度上昇 → 眠気アニメ → 就寝 → ゲームオーバー演出。
- UC-3: 面白い/関心一致の話題 → 退屈度低下 → 表情明るく、声色活発、親密度上昇。
- UC-4: TTS待ち →「考える/首かしげ/相槌」等の軽動作で間を繋ぐ。
- UC-5: 音声完成 → 句読点単位で順次再生/口パク同期 → 字幕を段階的に表示。

## 6. 機能要件（FR）
### 6.1 対話/LLMオーケストレーション
- FR-1: サーバーはユーザー発話を受け取り、LLMへ問い合わせるが、直接的な生テキスト出力を返さず、以下の構造体で返却する。
  - intent（意図）: 応答種別/行動タイプ
  - topic（話題）: 話題カテゴリ/難易度/興味推定
  - emotion（感情）: 喜/怒/哀/楽/困惑/退屈/眠い/照れ など（スコア0–1）
  - prosody（声）: pitch/speed/energy/brightness など（推奨範囲）
  - text: 応答本文（句読点入り）
  - flags: 退屈度/眠気/親密度/禁止話題フラグなどの更新差分
- FR-2: サーバーは会話フラグ（状態機械）を一貫管理。各ターンで更新してクライアントへ配布。
- FR-3: 安全フィルタ（年齢不相応/不適切コンテンツ遮断）を必須実装。

### 6.2 音声/TTS
- FR-4: 既定声は Coeiroink「MANA（ねむねむ）」を使用。
- FR-5: 感情や親密度により TTS パラメーター（pitch/speed/energy/etc）を動的調整。
- FR-6: 応答テキストは句読点（「。」「、」「！」「？」等）で分割し、チャンク単位で TTS API を順次 fetch。
- FR-7: 最初のチャンク取得後にすぐ再生を開始し、以降はストリーミング再生（キュー）でギャップを最小化。
- FR-8: TTS 音声が到着してから口パク開始。未到着の間は考えモーション/相槌で時間を繋ぐ。
- FR-9: TTS 失敗時はフォールバック（別声/合成簡易声/再試行）を行う。

### 6.3 口パク/表情/モーション
- FR-10: 口パクはビセームまたは振幅ベースで同期。TTSがビセーム/phoneme情報を持たない場合はエネルギー包絡で近似。
- FR-11: 表情: blendshape（例）
  - joy/happy, sad, angry, surprised, confused, bored, drowsy（眠気）, blush（照れ）
  - mouth: A/I/U/E/O, closed, smile, frown
- FR-12: モーションセット（アイドル/相槌/考える/首かしげ/眠気/就寝/起床）。
- FR-13: 感情→表情・声色マッピング（詳細は 9. 感情/声色マップ）。

### 6.4 ゲーム性（退屈→眠気→就寝）
- FR-14: 退屈度（0–100）を保持。つまらない/難しすぎる話題で上昇、面白い/適度だと減少。
- FR-15: 閾値1（例: 60）で「退屈」表情・声色。閾値2（例: 80）で「眠気」モーション。閾値3（例: 95）で「就寝」→ゲームオーバー。
- FR-16: ゲームオーバー画面/演出/リトライ導線。
- FR-17: 親密度により退屈度の上昇/減衰係数や許容時間を補正。

### 6.5 チャット表示
- FR-18: 音声側の最初のチャンク再生開始後、テキストを字幕風に徐々に表示（音声進行と概ね同期）。
- FR-19: スキップ/早送り/一時停止を提供（任意設定）。
- FR-20: 重要語・感情に応じた軽いハイライト（任意）。

### 6.6 UI/UX（改善方針）
- FR-21: レイアウト（想定）
  - 左: 3Dビューポート（キャラ中心、表情が見やすい構図）
  - 右上: 状態メーター（退屈度/眠気/親密度）
  - 右下: チャットパネル（字幕表示、入力欄、送信/録音）
  - 下部: クイック反応（相槌、話題切替、雑談/クイズ/豆知識など）
- FR-22: 待機中アニメーションの多様化（軽い視線移動、呼吸、ふとしたジェスチャ）。
- FR-23: 音声先行でUIも変化（「考え中」→「話す」→「聞く」ステート表示）。
- FR-24: 設定: 音量、話速、感情の強さ、字幕速度、モーション頻度、難易度。
- FR-25: アクセシビリティ: 字幕ON/OFF、色覚配慮コントラスト、キーボード操作対応。

## 7. 非機能要件（NFR）
- NFR-1: 初回3D/音声の体感遅延 < 2.0s（キャッシュ後は < 1.0s を目標）。
- NFR-2: TTS チャンクの平均取得時間 < 800ms（ネットワーク状況に依存）。
- NFR-3: 音声–口パクの同期誤差 平均 < 120ms。
- NFR-4: 60fps を目標（低端末は 30fps フォールバック）。
- NFR-5: 障害時の自動再試行・フォールバック（TTS/LLM/テクスチャ読み込み）。
- NFR-6: 個人情報保護（音声/チャットログの保護、同意UI）。
- NFR-7: Coeiroink ライセンス/利用規約順守。

## 8. 状態機械（サマリ）
- Listening（聞く）→ Thinking（考える）→ Speaking（話す）
- Bored（退屈）: 退屈度が閾値1超で遷移（表情/声色/相槌頻度に影響）
- Drowsy（眠気）: 閾値2超で眠気アニメを周期的に発火
- Asleep（就寝）: 閾値3超で遷移 → GameOver
- Resume（再開）: リトライ/一定インタラクションで Listening に復帰

## 9. 感情/声色/表情マップ（参考レンジ）
- joy: 表情=smile+eye_bright、声= pitch +0.5〜+1.0st, speed +5〜10%
- interest: 表情=focus、声= energy +5〜10%
- confused: 表情=eyebrow_up+head_tilt、声= speed -5〜10%
- bored: 表情=half_eye+mouth_flat、声= brightness -10〜15%
- drowsy: 表情=slow_blink、モーション=うつらうつら、声= speed -10〜20%
- sad: 表情=mouth_down、声= pitch -0.5〜-1.0st, energy -10〜20%
- angry: 表情=eyebrow_down、声= energy +10〜20%
- blush: 表情=blush、声= breathiness +5〜10%

## 10. フラグ設計
- 難易度: easy/normal/hard（発話の専門性/抽象度/語彙量から推定）
- 興味一致度: 0–100（ユーザー履歴/反応で更新）
- 退屈度: 0–100（上昇: 長尺独白/難解/興味外、下降: 双方向/面白要素/成功イベント）
- 眠気: 0–100（退屈度から派生、時間経過で上昇）
- 親密度: 0–100（継続利用/良質応答で上昇、ゲームオーバーで微減）
- 禁止話題/年齢配慮: bool/カテゴリ配列（安全フィルタ）
- 時間帯/コンテキスト: 例: 夜は眠気増加のベース値上昇

## 11. TTS チャンク/再生アルゴリズム（概要）
1) サーバーが text と prosody 推奨を返す
2) クライアントで句読点分割（文/フレーズ）
3) 先頭チャンクを TTS fetch → 到着次第すぐ再生開始
4) 並行で次チャンクを先行fetch→再生キューへ
5) 口パクは再生開始時点でビセーム or 振幅追従を始動
6) テキスト字幕は音声再生進行に合わせて段階表示

## 12. API（暫定）
- POST `/api/turn`
  - req: `{sessionId, userInput: {text|audio}, flags, context}`
  - res: `{intent, topic, emotion, prosody, text, flagsDelta, safety: {blocked?, reasons[]}}`
- POST `/api/tts`
  - req: `{text, voice: {speaker: "coeiroink-mana-nemunemu"}, prosody}`
  - res: `{audioUrl|audioBytes, visemes?}`
- GET `/api/state`
  - res: `{flags, meters: {boredom, drowsy, intimacy}}`

## 13. 3D/リグ要件
- フェイシャル: 基本母音 A/I/U/E/O、笑顔/困惑/怒り/悲しい/退屈/眠気/照れ の blendshape。
- 眼: まばたき、視線、半目（退屈/眠気）。
- 身体: 軽い相槌/首かしげ/考える/眠気/就寝/起床のアニメクリップ。

## 14. データ/保存
- セッション/会話履歴、フラグ推移、親密度履歴。
- 音声キャッシュ（チャンク単位）、頻出テキストのTTS結果の短期キャッシュ。

## 15. ロギング/メトリクス
- レイテンシ（LLM/TTS/描画）、退屈度遷移、ゲームオーバー頻度、親密度推移。
- 異常率（TTS失敗/再試行）、同期誤差測定。

## 16. セキュリティ/コンプライアンス
- 中学生設定に反する不適切話題をサーバーでブロック（安全フィルタ必須）。
- 音声/チャットの保存は明示同意。匿名化ポリシー。
- Coeiroink 等のライセンス順守、クレジット表記ポリシー。

## 17. テスト方針
- 単体: 句読点分割、キュー制御、フラグ更新ロジック。
- 結合: 音声到着→口パク開始→字幕段階表示の同期。
- シナリオ: 退屈→眠気→就寝の閾値遷移、親密度補正。
- 回線劣化時: チャンク先行fetch/フォールバック再生のギャップ評価。

## 18. リスクと対策
- TTS遅延: チャンク化/先行fetch/キャッシュで緩和。
- 同期ずれ: キュー管理とタイムスタンプ補正、軽微の口形補間。
- 安全性: サーバー側フィルタとガードレール、NGトピック即時切替誘導。

## 19. ローンチMVP範囲（案）
- 基本対話（音声/テキスト）、退屈→眠気→就寝のゲーム性、字幕段階表示、Coerioink MANA（ねむねむ）対応、表情/口パク同期、簡易UI。

## 20. 将来拡張
- 複数ボイス/話者切替、表情学習、話題推薦、クイズ/ゲームモード追加、モバイル最適化（省電力）。

